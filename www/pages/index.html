<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <title>Registro de Animales - Organic Journal</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4D8143">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ProNatura">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../assets/icons/icon-152x152.png">
    <link rel="icon" type="image/jpeg" href="../assets/logo.jpg">
    <link rel="shortcut icon" type="image/jpeg" href="../assets/logo.jpg">

    <link rel="stylesheet" href="../assets/css/styles.css">
    <script>
        // VERIFICAR BAN ANTES DE ESTABLECER CUALQUIER FLAG
        // Esto debe ejecutarse ANTES de que auth.js se cargue para bloquear usuarios baneados
        (function() {
            try {
                const sessionData = sessionStorage.getItem('current_session') || localStorage.getItem('current_session');
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    if (session && session.id) {
                        // Verificar ban inmediatamente ANTES de permitir acceso
                        fetch('../api/api.php?action=check_ban_status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ usuario_id: session.id, email: session.email })
                        }).then(response => response.json()).then(data => {
                            if (data.banned) {
                                // Usuario baneado - guardar informaciÃ³n y redirigir a apelaciÃ³n
                                if (data.ban) {
                                    sessionStorage.setItem('ban_id_apelar', data.ban.id);
                                    sessionStorage.setItem('usuario_id_apelar', session.id); // Guardar usuario_id directamente
                                    sessionStorage.setItem('email_apelar', session.email);
                                    sessionStorage.setItem('ban_motivo', data.ban.motivo);
                                    sessionStorage.setItem('ban_tipo', data.ban.tipo);
                                }
                                sessionStorage.removeItem('index_acceso_permitido');
                                // NO limpiar sesiÃ³n todavÃ­a - mantener para apelaciÃ³n
                                // Redirigir directamente a pÃ¡gina de apelaciÃ³n
                                // Como index.html estÃ¡ en /pages/, usar ruta relativa simple
                                const currentUrl = window.location.href.toLowerCase();
                                const isHostinger = currentUrl.indexOf('hostinger') !== -1 || 
                                                   currentUrl.indexOf('hostingersite.com') !== -1 ||
                                                   currentUrl.indexOf('organicjournal.com.mx') !== -1;
                                
                                let apelarPath;
                                if (isHostinger) {
                                    // En Hostinger, usar ruta absoluta
                                    apelarPath = '/pages/apelar-ban.html';
                                } else {
                                    // En local, index.html estÃ¡ en /pages/, asÃ­ que usar ruta relativa simple
                                    apelarPath = 'apelar-ban.html';
                                }

                                window.location.href = apelarPath;
                            }
                        }).catch(error => {

                        });
                    }
                }
            } catch (error) {

            }
        })();
        
        // ESTABLECER FLAG DE ACCESO PERMITIDO INMEDIATAMENTE si viene de navegaciÃ³n interna
        // Esto debe ejecutarse ANTES de que auth.js se cargue para evitar redirecciones
        (function() {
            // ESTABLECER FLAG PERMANENTE INMEDIATAMENTE - esto previene cualquier redirecciÃ³n
            // Solo NO establecer si vienes explÃ­citamente de inicio/login/registro SIN sesiÃ³n
            const referrer = document.referrer || '';
            const vieneDeCancelacion = sessionStorage.getItem('vieneDeCancelacion') === 'true';
            const vieneDeLogin = sessionStorage.getItem('vieneDeLogin') === 'true';
            const navegandoInternamente = sessionStorage.getItem('navegando_internamente') === 'true';
            const tieneSesion = sessionStorage.getItem('current_session') !== null;
            
            // PRIORIDAD 1: Si el flag de navegaciÃ³n interna estÃ¡ activo (establecido antes de navegar)
            if (navegandoInternamente) {
                sessionStorage.setItem('index_acceso_permitido', 'true');
                sessionStorage.removeItem('navegando_internamente'); // Limpiar flag

                return; // Salir inmediatamente
            }
            
            // PRIORIDAD 2: Si viene de navegaciÃ³n interna detectada por referrer
            const esNavegacionInterna = referrer && referrer.length > 0 && (
                referrer.includes('mapa-consolidado.html') ||
                referrer.includes('bloc-notas.html') ||
                referrer.includes('nuevo-registro.html') ||
                referrer.includes('catalogo.html') ||
                referrer.includes('admin.html') ||
                (referrer.includes('index.html') && !referrer.includes('inicio.html')) ||
                // DetecciÃ³n mÃ¡s flexible: si viene del mismo dominio y NO es inicio/login/registro
                (referrer.includes(window.location.hostname) && 
                 !referrer.includes('inicio.html') && 
                 !referrer.includes('login.html') &&
                 !referrer.includes('registro.html')) ||
                // DetecciÃ³n por pathname si estÃ¡ disponible
                (referrer.includes('/pages/') && 
                 !referrer.includes('inicio.html') && 
                 !referrer.includes('login.html') &&
                 !referrer.includes('registro.html'))
            );
            
            // REGLA GENERAL: Si hay sesiÃ³n activa, PERMITIR SIEMPRE
            if (tieneSesion) {
                sessionStorage.setItem('index_acceso_permitido', 'true');

                return;
            }
            
            // Si viene de navegaciÃ³n interna O tiene flags activos, PERMITIR
            if (esNavegacionInterna || vieneDeCancelacion || vieneDeLogin) {
                sessionStorage.setItem('index_acceso_permitido', 'true');

                return;
            }
            
            // Si NO hay referrer (puede ser recarga o navegaciÃ³n directa), PERMITIR por seguridad
            if (!referrer || referrer.length === 0) {
                sessionStorage.setItem('index_acceso_permitido', 'true');

                return;
            }
            
            // SOLO NO establecer flag si vienes EXPLÃCITAMENTE de inicio/login/registro SIN sesiÃ³n
            const vieneDeInicioLoginRegistro = referrer.includes('inicio.html') || 
                                               referrer.includes('login.html') ||
                                               referrer.includes('registro.html');
            
            if (vieneDeInicioLoginRegistro && !tieneSesion) {

                // NO establecer flag - dejar que auth.js maneje la redirecciÃ³n
            } else {
                // En cualquier otro caso, establecer flag por seguridad
                sessionStorage.setItem('index_acceso_permitido', 'true');

            }
        })();
    </script>
    <style>
        /* Estilos responsivos especÃ­ficos para index.html */
        @media (max-width: 768px) {
            .filter-container {
                padding: 1rem !important;
            }

            .filter-container > div {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 1rem !important;
            }

            .filter-container label {
                width: 100% !important;
                text-align: left !important;
            }

            .filter-select {
                width: 100% !important;
                min-width: auto !important;
                max-width: 100% !important;
            }
        }
    </style>

</head>

<body>

    <!-- Header -->

    <header class="header teal-header">

        <h1>Registro de Animales</h1>

        <nav class="nav-bar">

            <a href="index.html" class="nav-item active">

                <span class="nav-icon">ğŸ“š</span>

                Biblioteca

            </a>

            <a href="mapa-consolidado.html" class="nav-item">

                <span class="nav-icon">ğŸ—º</span>

                Mapa Consolidado

            </a>

            <a href="bloc-notas.html" class="nav-item">

                <span class="nav-icon">ğŸ“</span>

                Bloc de Notas

            </a>

            <a href="grupos.html" class="nav-item" id="gruposNavItem" style="display: none;">

                <span class="nav-icon">ğŸ‘¥</span>

                Grupos

            </a>

            <a href="admin.html" class="nav-item admin-nav-item" id="adminNavItem" style="display: none;">

                <span class="nav-icon">âš™</span>

                AdministraciÃ³n

            </a>

        </nav>

        <div class="user-info" id="userInfoWrap">
            <div class="profile-dropdown-wrapper">
                <button type="button" class="profile-trigger" id="profileTrigger" aria-expanded="false" aria-haspopup="true" aria-label="Abrir menÃº de usuario">
                    <span class="profile-avatar" id="profileAvatar" style="width:22px;height:22px;min-width:22px;min-height:22px;max-width:22px;max-height:22px;overflow:hidden;flex-shrink:0;display:inline-flex;align-items:center;justify-content:center;border-radius:50%"><img src="../assets/icons/perfil-removebg-preview.png" alt="" style="width:100%;height:100%;max-width:22px;max-height:22px;object-fit:cover;display:block"></span>
                    <span class="user-name" id="userName"></span>
                    <span class="profile-chevron" aria-hidden="true">â–¼</span>
                </button>
                <div class="profile-dropdown" id="profileDropdown" role="menu" hidden style="position: absolute !important; top: 100% !important; right: 0 !important; left: auto !important; width: 320px !important;">
                <div class="profile-dropdown-header">
                    <div class="profile-dropdown-name" id="profileDropdownName"></div>
                    <div class="profile-dropdown-email" id="profileDropdownEmail"></div>
                </div>
                <div class="profile-dropdown-links" style="display: flex !important; flex-direction: column !important; gap: 0.5rem !important; padding: 0.75rem !important;">
                    <a href="catalogo.html" class="profile-dropdown-link" role="menuitem" style="display: block !important; width: 100% !important; margin-bottom: 0.5rem !important;"><span class="profile-dropdown-icon">ğŸŒ³</span> CatÃ¡logo de categorÃ­as</a>
                    <a href="recuperar-contraseÃ±a.html" class="profile-dropdown-link" role="menuitem" style="display: block !important; width: 100% !important; margin-bottom: 0.5rem !important;"><span class="profile-dropdown-icon">ğŸ”</span> Cambiar contraseÃ±a</a>
                    <a href="inicio.html" class="profile-dropdown-link" role="menuitem" style="display: block !important; width: 100% !important; margin-bottom: 0.5rem !important;"><span class="profile-dropdown-icon">ğŸ </span> Ir al inicio</a>
                    <a href="admin.html" class="profile-dropdown-link" id="profileDropdownAdmin" style="display: none; width: 100% !important; margin-bottom: 0.5rem !important;" role="menuitem"><span class="profile-dropdown-icon">âš™</span> AdministraciÃ³n</a>
                </div>
                <div class="profile-dropdown-divider"></div>
                <button type="button" class="profile-dropdown-item logout" id="profileLogoutBtn" role="menuitem"><span class="profile-dropdown-icon">ğŸšª</span> Cerrar sesiÃ³n</button>
                </div>
            </div>
        </div>
    </header>
    <script>
    (function(){ var p = (window.location.pathname || ''); var base = p.indexOf('/pages/') !== -1 ? '../' : ''; var el = document.getElementById('profileAvatar'); if (el) { var img = el.querySelector('img'); if (img) img.src = base + 'assets/icons/perfil-removebg-preview.png'; } })();
    (function(){ var path = window.location.pathname || ''; if (path.indexOf('/pages/') === -1) { var segs = path.split('/').filter(Boolean); if (segs.length <= 1) { document.querySelectorAll('.nav-bar .nav-item').forEach(function(a){ var h = a.getAttribute('href'); if (h && !/^https?:/.test(h) && h.charAt(0) !== '/') a.setAttribute('href', 'pages/' + h); }); } } })();
    </script>
    <!-- Modal: Â¿Acceder a chats o nueva solicitud? -->
    <div id="chatChoiceModal" class="email-modal" style="display: none; position: fixed; inset: 0; z-index: 9999; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);">
        <div class="email-modal-content chat-choice-content" style="background: rgba(255,255,255,0.7); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-radius: 16px; padding: 2rem 2.25rem; max-width: 420px; width: 90%; box-shadow: 0 25px 50px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.8);">
            <h2>ğŸ’¬ Chat de Ejidos</h2>
            <p style="margin: 1rem 0;">Â¿QuÃ© deseas hacer?</p>
            <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.25rem;">
                <button type="button" id="btnAccederChats" class="btn-primary" style="width: 100%; padding: 0.9rem;">Acceder a mis chats</button>
                <button type="button" id="btnNuevaSolicitud" class="btn-secondary" style="width: 100%; padding: 0.9rem;">Enviar nueva solicitud</button>
                <button type="button" id="btnCancelarChatChoice" class="btn-secondary" style="width: 100%; padding: 0.6rem; background: #e0e0e0;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Search and Action Bar -->

    <div class="search-bar-container">

        <div class="search-wrapper">

            <span class="search-icon">ğŸ”</span>

            <input type="text" id="searchInput" class="search-input" placeholder="Buscar registros...">

        </div>

        <div class="action-buttons">

            <button class="btn-filter" id="sortBtn">

                <span>ğŸ”„</span>

                Recientes primero

            </button>

            <button class="btn-primary" id="newRecordBtn">

                <span>+</span>

                Nuevo Registro

            </button>

        </div>

    </div>

    <!-- Filtros de CategorÃ­a y SubcategorÃ­a -->

    <div class="filter-container" style="padding: 1rem 2rem; background: white; border-bottom: 1px solid #e0e0e0;">

        <div style="display: flex; gap: 1rem; align-items: center; max-width: 1200px; margin: 0 auto;">

            <label style="font-weight: 600; color: #4D8143;">Filtrar por:</label>

            <select id="filterCategoria" class="filter-select" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem; min-width: 250px;">

                <option value="">Todas las categorias</option>

            </select>

            <select id="filterSubcategoria" class="filter-select" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem; min-width: 250px;" disabled>

                <option value="">Todas las subcategorias</option>

            </select>

        </div>

    </div>

    <!-- Main Content -->

    <main class="main-content">

        <div class="records-grid" id="recordsGrid">

            <!-- Los registros se cargarÃ¡n dinÃ¡micamente aquÃ­ -->

        </div>

    </main>

    <!-- Modal para confirmar eliminaciÃ³n -->

    <div id="deleteModal" class="modal">

        <div class="modal-content">

            <h3>Â¿Eliminar registro?</h3>

            <p>Esta acciÃ³n no se puede deshacer.</p>

            <div class="modal-actions">

                <button class="btn-cancel" id="cancelDeleteBtn">Cancelar</button>

                <button class="btn-delete" id="confirmDeleteBtn">Eliminar</button>

            </div>

        </div>

    </div>

    <script src="../assets/js/auth.js"></script>

    <script src="../assets/js/script.js"></script>

    <script>

        // ELIMINADA la verificaciÃ³n de autenticaciÃ³n aquÃ­
        // auth.js manejarÃ¡ la verificaciÃ³n correctamente
        // Solo limpiar el flag de vieneDeLogin si existe
        document.addEventListener('DOMContentLoaded', () => {
            const vieneDeLogin = sessionStorage.getItem('vieneDeLogin') === 'true';
            if (vieneDeLogin) {
                sessionStorage.removeItem('vieneDeLogin');

            }
            
            // INTERCEPTAR CLICS EN ENLACES DE NAVEGACIÃ“N para establecer flag antes de navegar
            const navLinks = document.querySelectorAll('.nav-bar a[href]');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    // Si NO es index.html (Biblioteca), establecer flag de navegaciÃ³n interna
                    if (href && href !== 'index.html' && !href.includes('inicio.html') && !href.includes('login.html') && !href.includes('registro.html')) {

                        // Establecer flag que indica que el usuario estÃ¡ navegando internamente
                        sessionStorage.setItem('navegando_internamente', 'true');
                        sessionStorage.setItem('pagina_destino', href);
                        // Cuando regrese a index.html, este flag permitirÃ¡ el acceso
                        sessionStorage.setItem('index_acceso_permitido', 'true');
                    }
                });
            });

        });

        // Mostrar informaciÃ³n del usuario

        document.addEventListener('DOMContentLoaded', async () => {

            const user = window.authSystem.getCurrentUser();

            if (user) {

                const nombre = user.nombre || 'Usuario';
                const inicial = nombre.charAt(0).toUpperCase();
                document.getElementById('userName').textContent = nombre;
                var av = document.getElementById('profileAvatar'); if (av && !av.querySelector('img')) av.textContent = inicial;
                document.getElementById('profileDropdownName').textContent = nombre;
                document.getElementById('profileDropdownEmail').textContent = user.email || '';

                // Verificar rol desde la API si no estÃ¡ en la sesiÃ³n

                let userRol = user.rol;

                if (!userRol) {

                    try {

                        const response = await fetch(`../api/api.php?action=get_user_info&user_id=${user.id}`);

                        const data = await response.json();

                        if (data.success && data.user && data.user.rol) {

                            userRol = data.user.rol;

                            // Actualizar la sesiÃ³n con el rol

                            const updatedUser = { ...user, rol: userRol };

                            window.authSystem.setSession(updatedUser);

                        }

                    } catch (error) {

                    }

                }

                // Mostrar botÃ³n de administraciÃ³n si es admin
                if (userRol === 'admin') {
                    const adminNavItem = document.getElementById('adminNavItem');
                    if (adminNavItem) {
                        adminNavItem.style.display = 'flex';
                    }
                    const profileAdmin = document.getElementById('profileDropdownAdmin');
                    if (profileAdmin) {
                        profileAdmin.style.display = 'flex';
                    }
                }

                // Mostrar enlace de Grupos si estÃ¡ autenticado
                const gruposNavItem = document.getElementById('gruposNavItem');
                if (gruposNavItem) {
                    gruposNavItem.style.display = 'flex';

                    // Interceptar clic en Grupos: mostrar pregunta "Â¿Acceder a chats o nueva solicitud?"
                    gruposNavItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const modal = document.getElementById('chatChoiceModal');
                        if (modal) {
                            modal.style.display = 'flex';
                            modal.classList.add('show');
                        }
                    });

                    // Botones del modal de elecciÃ³n chat/solicitud
                    (function() {
                        const modal = document.getElementById('chatChoiceModal');
                        const btnChats = document.getElementById('btnAccederChats');
                        const btnSolicitud = document.getElementById('btnNuevaSolicitud');
                        const btnCancelar = document.getElementById('btnCancelarChatChoice');
                        if (!modal) return;

                        function closeModal() {
                            modal.style.display = 'none';
                            modal.classList.remove('show');
                        }
                        async function goToChat() {
                            const baseUrl = window.location.origin;
                            const path = window.location.pathname;
                            const basePath = path.includes('/pages/') ? path.substring(0, path.lastIndexOf('/') + 1) : (path.replace(/[^/]*$/, '') || '/');
                            let estado = sessionStorage.getItem('chat_estado') || '';
                            let municipio = sessionStorage.getItem('chat_municipio') || '';
                            let ciudad = sessionStorage.getItem('chat_ciudad') || '';
                            if (!estado) {
                                try {
                                    const sessionJson = sessionStorage.getItem('current_session') || localStorage.getItem('current_session');
                                    const session = sessionJson ? JSON.parse(sessionJson) : null;
                                    const userId = session && session.id != null ? parseInt(session.id, 10) : 0;
                                    if (userId > 0 && userId < 2000000000) {
                                        const apiBase = path.includes('/pages/') ? (baseUrl + basePath + '../api/chat_api.php') : (baseUrl + '/api/chat_api.php');
                                        const res = await fetch(apiBase + '?action=obtener_grupos&usuario_id=' + userId);
                                        const data = await res.json();
                                        if (data.success && data.grupos && data.grupos.length > 0) {
                                            const preferir = data.grupos.find(function(g) { return (g.nombre || '').trim() !== 'Ejidos MÃ©xico'; });
                                            const grupo = preferir || data.grupos[0];
                                            const nombre = (grupo.nombre || '').trim();
                                            if ((grupo.nombre || '').trim() !== 'Ejidos MÃ©xico') {
                                                if ((grupo.estado || '').trim()) estado = (grupo.estado || '').trim();
                                                else if (nombre.indexOf('Ejidos ') === 0) estado = nombre.substring(7);
                                            }
                                        }
                                    }
                                } catch (e) { }
                            }
                            closeModal();
                            let chatUrl = path.includes('/pages/') ? baseUrl + path.replace('index.html', 'chat.html') : baseUrl + '/pages/chat.html';
                            if (estado) {
                                chatUrl += '?estado=' + encodeURIComponent(estado);
                                if (municipio) chatUrl += '&municipio=' + encodeURIComponent(municipio);
                                if (ciudad) chatUrl += '&ciudad=' + encodeURIComponent(ciudad);
                            }
                            window.location.href = chatUrl;
                        }
                        function goToGrupos() {
                            const baseUrl = window.location.origin;
                            const path = window.location.pathname;
                            const gruposUrl = path.includes('/pages/') ? baseUrl + path.replace('index.html', 'grupos.html') : baseUrl + '/pages/grupos.html';
                            closeModal();
                            window.location.href = gruposUrl;
                        }

                        if (btnChats) btnChats.addEventListener('click', goToChat);
                        if (btnSolicitud) btnSolicitud.addEventListener('click', goToGrupos);
                        if (btnCancelar) btnCancelar.addEventListener('click', closeModal);
                        modal.addEventListener('click', function(ev) {
                            if (ev.target === modal) closeModal();
                        });
                    })();
                }

            }

            // MenÃº de perfil plegable
            const profileTrigger = document.getElementById('profileTrigger');
            const profileDropdown = document.getElementById('profileDropdown');
            const profileLogoutBtn = document.getElementById('profileLogoutBtn');

            if (profileTrigger && profileDropdown) {
                profileTrigger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = profileDropdown.classList.toggle('is-open');
                    profileTrigger.classList.toggle('is-open', isOpen);
                    profileTrigger.setAttribute('aria-expanded', isOpen);
                    profileDropdown.hidden = !isOpen;
                });
                document.addEventListener('click', function() {
                    profileDropdown.classList.remove('is-open');
                    profileTrigger.classList.remove('is-open');
                    profileTrigger.setAttribute('aria-expanded', 'false');
                    profileDropdown.hidden = true;
                });
            }

            if (profileLogoutBtn) {
                profileLogoutBtn.addEventListener('click', () => {
                    if (confirm('Â¿Deseas cerrar sesiÃ³n?')) {
                        window.authSystem.logout();
                        window.location.href = 'inicio.html';
                    }
                });
            }

        });

    </script>
    
    <!-- PWA Service Worker Registration -->
    <script src="../assets/js/pwa-register.js?v=2"></script>
    
    <!-- Bloquear navegaciÃ³n con flechas del navegador -->
    <script src="../assets/js/block-navigation.js"></script>

</body>

</html>
