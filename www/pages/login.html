<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Iniciar Sesi√≥n - Contralor√≠a Social Tamaulipas</title>

    <link rel="stylesheet" href="../assets/css/styles.css" id="cssLink">
    <script>
        // Corregir ruta del CSS para Hostinger
        (function() {
            var currentUrl = window.location.href.toLowerCase();
            var cssLink = document.getElementById('cssLink');
            if (cssLink && (currentUrl.indexOf('hostinger') !== -1 || 
                           currentUrl.indexOf('hostingersite.com') !== -1 ||
                           currentUrl.indexOf('organicjournal.com.mx') !== -1)) {
                cssLink.href = 'assets/css/styles.css';
            }
        })();
    </script>

    <style>

        .auth-container {

            min-height: 100vh;

            display: flex;

            align-items: center;

            justify-content: center;

            background: linear-gradient(135deg, #4D8143 30%, #ffffff 70%);

            padding: 2rem;

        }

        

        .auth-box {

            background: white;

            border-radius: 12px;

            padding: 3rem;

            max-width: 450px;

            width: 100%;

            box-shadow: 0 10px 40px rgba(0,0,0,0.2);

        }

        

        .auth-title {

            font-size: 2rem;

            color: #2c7a7b;

            margin-bottom: 0.5rem;

            text-align: center;

        }

        

        .auth-subtitle {

            color: #666;

            text-align: center;

            margin-bottom: 2rem;

        }

        

        .auth-form {

            display: flex;

            flex-direction: column;

            gap: 1.5rem;

        }

        

        .form-group {

            display: flex;

            flex-direction: column;

        }

        

        .form-group label {

            font-weight: 600;

            margin-bottom: 0.5rem;

            color: #333;

        }

        

        .form-group input {

            padding: 0.8rem;

            border: 2px solid #e0e0e0;

            border-radius: 8px;

            font-size: 1rem;

            transition: border-color 0.3s;

        }

        

        .form-group input:focus {

            outline: none;

            border-color: #2c7a7b;

        }

        

        .btn-submit {

            padding: 0.9rem;

            background: #2c7a7b;

            color: white;

            border: none;

            border-radius: 8px;

            font-size: 1.1rem;

            font-weight: 600;

            cursor: pointer;

            transition: background 0.3s;

            margin-top: 0.5rem;

        }

        

        .btn-submit:hover {

            background: #1a5f5f;

        }

        

        .auth-link {

            text-align: center;

            margin-top: 1.5rem;

            color: #666;

        }

        

        .auth-link a {

            color: #2c7a7b;

            text-decoration: none;

            font-weight: 600;

        }

        

        .auth-link a:hover {

            text-decoration: underline;

        }

        

        .error-message {

            background: #fee;

            color: #c33;

            padding: 0.8rem;

            border-radius: 8px;

            margin-bottom: 1rem;

            display: none;

        }

        

        .error-message.show {

            display: block;

        }

        /* Estilos para ver/ocultar contrase√±a */
        .password-wrapper {
            position: relative;
            width: 100%;
        }

        .password-wrapper input {
            padding-right: 45px;
            width: 100%;
            box-sizing: border-box;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #666;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s;
        }

        .password-toggle:hover {
            color: #2c7a7b;
        }

        .password-toggle:focus {
            outline: none;
        }

    </style>

</head>

<body>

    <div class="auth-container">

        <div class="auth-box">

            <h1 class="auth-title">Iniciar Sesi√≥n</h1>

            <p class="auth-subtitle">Accede a tu cuenta para registrar evidencia</p>

            

            <div id="errorMessage" class="error-message"></div>

            

            <form id="loginForm" class="auth-form">

                <div class="form-group">

                    <label for="email">Correo Electr√≥nico</label>

                    <input type="email" id="email" name="email" required autocomplete="email">

                </div>

                

                <div class="form-group">

                    <label for="password">Contrase√±a</label>

                    <div class="password-wrapper">
                        <input type="password" id="password" name="password" required autocomplete="current-password">
                        <button type="button" class="password-toggle" onclick="togglePassword('password', this)" aria-label="Mostrar contrase√±a">
                            üëÅÔ∏è
                        </button>
                    </div>

                </div>

                

                <button type="submit" class="btn-submit">Iniciar Sesi√≥n</button>

            </form>

            

            <div class="auth-link">

                ¬øNo tienes cuenta? <a href="registro.html">Reg√≠strate aqu√≠</a>

            </div>

            <div class="auth-link" style="margin-top: 0.5rem;">

                <a href="recuperar-contrase√±a.html" style="color: #666; font-size: 0.9rem;">¬øOlvidaste tu contrase√±a?</a>

            </div>

        </div>

    </div>

    

    <script src="../assets/js/auth.js" id="authScript"></script>
    <script>
        // Corregir ruta del script para Hostinger
        (function() {
            var currentUrl = window.location.href.toLowerCase();
            var authScript = document.getElementById('authScript');
            if (authScript && (currentUrl.indexOf('hostinger') !== -1 || 
                              currentUrl.indexOf('hostingersite.com') !== -1 ||
                              currentUrl.indexOf('organicjournal.com.mx') !== -1)) {
                authScript.src = 'assets/js/auth.js';
            }
        })();
    </script>

    <script>
        // Prellenar email si viene del modal de verificaci√≥n
        (function() {
            var prefillEmail = sessionStorage.getItem('prefillEmail');
            if (prefillEmail) {
                var emailInput = document.getElementById('email');
                if (emailInput) {
                    emailInput.value = prefillEmail;
                    // Limpiar el valor de sessionStorage despu√©s de usarlo
                    sessionStorage.removeItem('prefillEmail');
                }
            }
        })();
    </script>

    <script>

        document.getElementById('loginForm').addEventListener('submit', async (e) => {

            e.preventDefault();

            

            const email = document.getElementById('email').value.trim();

            const password = document.getElementById('password').value;

            const errorDiv = document.getElementById('errorMessage');

            const submitBtn = e.target.querySelector('button[type="submit"]');

            

            errorDiv.classList.remove('show');

            

            // Deshabilitar bot√≥n mientras se procesa

            submitBtn.disabled = true;

            submitBtn.textContent = 'Iniciando sesi√≥n...';

            

            try {

                const result = await window.authSystem.login(email, password);

                if (result.success) {

                    // Verificar que la sesi√≥n se haya guardado correctamente
                    let user = window.authSystem.getCurrentUser();
                    
                    // Si no hay usuario, intentar obtenerlo de nuevo despu√©s de un peque√±o delay
                    if (!user) {
                        console.log('‚ö†Ô∏è Usuario no encontrado inmediatamente, esperando...');
                        await new Promise(resolve => setTimeout(resolve, 200));
                        user = window.authSystem.getCurrentUser();
                    }
                    
                    if (!user) {
                        console.error('‚ùå Error: La sesi√≥n no se guard√≥ correctamente');
                        console.error('‚ùå localStorage actual:', localStorage.getItem('current_session'));
                        errorDiv.textContent = 'Error al guardar la sesi√≥n. Intenta nuevamente.';
                        errorDiv.classList.add('show');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Iniciar Sesi√≥n';
                        return;
                    }

                    console.log('‚úÖ Login exitoso, usuario:', user);
                    console.log('‚úÖ Sesi√≥n guardada en localStorage');
                    
                    // Esperar un momento adicional para asegurar que localStorage se sincronice completamente
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // Verificar una vez m√°s antes de redirigir
                    const finalCheck = window.authSystem.getCurrentUser();
                    if (!finalCheck) {
                        console.error('‚ùå Error cr√≠tico: La sesi√≥n se perdi√≥ antes de redirigir');
                        errorDiv.textContent = 'Error cr√≠tico. Por favor recarga la p√°gina e intenta nuevamente.';
                        errorDiv.classList.add('show');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Iniciar Sesi√≥n';
                        return;
                    }

                    // Si es administrador, ofrecer ir al panel de admin o a la biblioteca

                    if (user && user.rol === 'admin') {

                        if (confirm('¬øDeseas ir al Panel de Administraci√≥n?')) {

                            window.location.href = 'admin.html';

                        } else {

                            // Marcar que viene de login para permitir acceso a index.html
                            sessionStorage.setItem('vieneDeLogin', 'true');
                            window.location.href = 'index.html';

                        }

                    } else {

                        // Marcar que viene de login para permitir acceso a index.html
                        sessionStorage.setItem('vieneDeLogin', 'true');
                        window.location.href = 'index.html';

                    }

                } else {
                    // Verificar si el error es por ban y si puede apelar
                    const banId = result.ban_id;
                    const puedeApelar = result.puede_apelar === true;
                    
                    errorDiv.textContent = result.message || 'Correo o contrase√±a incorrectos';
                    errorDiv.classList.add('show');
                    
                    // Si hay ban y puede apelar, mostrar bot√≥n de apelar
                    if (banId && puedeApelar) {
                        const apelarBtn = document.createElement('button');
                        apelarBtn.type = 'button';
                        apelarBtn.className = 'btn-apelar';
                        apelarBtn.textContent = 'Apelar Ban';
                        apelarBtn.style.cssText = 'margin-top: 1rem; padding: 0.75rem 1.5rem; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600;';
                        apelarBtn.onclick = () => {
                            sessionStorage.setItem('ban_id_apelar', banId);
                            sessionStorage.setItem('email_apelar', email);
                            window.location.href = 'apelar-ban.html';
                        };
                        
                        // Remover bot√≥n anterior si existe
                        const btnAnterior = errorDiv.parentElement.querySelector('.btn-apelar');
                        if (btnAnterior) btnAnterior.remove();
                        
                        errorDiv.parentElement.appendChild(apelarBtn);
                    }

                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Iniciar Sesi√≥n';

                }

            } catch (error) {

                console.error('Error en login:', error);

                errorDiv.textContent = 'Error de conexi√≥n. Intenta nuevamente.';

                errorDiv.classList.add('show');

                submitBtn.disabled = false;

                submitBtn.textContent = 'Iniciar Sesi√≥n';

            }

        });

        // Funci√≥n para alternar visibilidad de contrase√±a
        function togglePassword(inputId, button) {
            var input = document.getElementById(inputId);
            if (input) {
                if (input.type === 'password') {
                    input.type = 'text';
                    button.textContent = 'üôà';
                    button.setAttribute('aria-label', 'Ocultar contrase√±a');
                } else {
                    input.type = 'password';
                    button.textContent = 'üëÅÔ∏è';
                    button.setAttribute('aria-label', 'Mostrar contrase√±a');
                }
            }
        }

    </script>

</body>

</html>
