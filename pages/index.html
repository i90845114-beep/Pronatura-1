<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Registro de Animales - Contralor√≠a Social Tamaulipas</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4D8143">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ProNatura">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../assets/icons/icon-152x152.png">
    <link rel="icon" type="image/png" href="../assets/icons/icon-96x96.png">
    <link rel="shortcut icon" type="image/png" href="../assets/icons/icon-96x96.png">

    <link rel="stylesheet" href="../assets/css/styles.css">
    <script>
        // ESTABLECER FLAG DE ACCESO PERMITIDO INMEDIATAMENTE si viene de navegaci√≥n interna
        // Esto debe ejecutarse ANTES de que auth.js se cargue para evitar redirecciones
        (function() {
            // ESTABLECER FLAG PERMANENTE INMEDIATAMENTE - esto previene cualquier redirecci√≥n
            // Solo NO establecer si vienes expl√≠citamente de inicio/login/registro SIN sesi√≥n
            const referrer = document.referrer || '';
            const vieneDeCancelacion = sessionStorage.getItem('vieneDeCancelacion') === 'true';
            const vieneDeLogin = sessionStorage.getItem('vieneDeLogin') === 'true';
            const navegandoInternamente = sessionStorage.getItem('navegando_internamente') === 'true';
            const tieneSesion = sessionStorage.getItem('current_session') !== null;
            
            // PRIORIDAD 1: Si el flag de navegaci√≥n interna est√° activo (establecido antes de navegar)
            if (navegandoInternamente) {
                sessionStorage.setItem('index_acceso_permitido', 'true');
                sessionStorage.removeItem('navegando_internamente'); // Limpiar flag
                console.log('‚úÖ [index.html HEAD] Flag de navegaci√≥n interna detectado - ACCESO PERMITIDO');
                return; // Salir inmediatamente
            }
            
            // PRIORIDAD 2: Si viene de navegaci√≥n interna detectada por referrer
            const esNavegacionInterna = referrer && referrer.length > 0 && (
                referrer.includes('mapa-consolidado.html') ||
                referrer.includes('bloc-notas.html') ||
                referrer.includes('nuevo-registro.html') ||
                referrer.includes('catalogo.html') ||
                referrer.includes('admin.html') ||
                (referrer.includes('index.html') && !referrer.includes('inicio.html')) ||
                // Detecci√≥n m√°s flexible: si viene del mismo dominio y NO es inicio/login/registro
                (referrer.includes(window.location.hostname) && 
                 !referrer.includes('inicio.html') && 
                 !referrer.includes('login.html') &&
                 !referrer.includes('registro.html')) ||
                // Detecci√≥n por pathname si est√° disponible
                (referrer.includes('/pages/') && 
                 !referrer.includes('inicio.html') && 
                 !referrer.includes('login.html') &&
                 !referrer.includes('registro.html'))
            );
            
            // REGLA GENERAL: Si hay sesi√≥n activa, PERMITIR SIEMPRE
            if (tieneSesion) {
                sessionStorage.setItem('index_acceso_permitido', 'true');
                console.log('‚úÖ [index.html HEAD] Sesi√≥n activa detectada - ACCESO PERMITIDO');
                return;
            }
            
            // Si viene de navegaci√≥n interna O tiene flags activos, PERMITIR
            if (esNavegacionInterna || vieneDeCancelacion || vieneDeLogin) {
                sessionStorage.setItem('index_acceso_permitido', 'true');
                console.log('‚úÖ [index.html HEAD] Flag de acceso permitido establecido INMEDIATAMENTE');
                console.log('üîç [index.html HEAD] Referrer:', referrer);
                console.log('üîç [index.html HEAD] Viene de cancelaci√≥n:', vieneDeCancelacion);
                console.log('üîç [index.html HEAD] Viene de login:', vieneDeLogin);
                console.log('üîç [index.html HEAD] Es navegaci√≥n interna:', esNavegacionInterna);
                return;
            }
            
            // Si NO hay referrer (puede ser recarga o navegaci√≥n directa), PERMITIR por seguridad
            if (!referrer || referrer.length === 0) {
                sessionStorage.setItem('index_acceso_permitido', 'true');
                console.log('‚úÖ [index.html HEAD] Referrer vac√≠o - PERMITIENDO ACCESO por seguridad');
                return;
            }
            
            // SOLO NO establecer flag si vienes EXPL√çCITAMENTE de inicio/login/registro SIN sesi√≥n
            const vieneDeInicioLoginRegistro = referrer.includes('inicio.html') || 
                                               referrer.includes('login.html') ||
                                               referrer.includes('registro.html');
            
            if (vieneDeInicioLoginRegistro && !tieneSesion) {
                console.log('‚ö†Ô∏è [index.html HEAD] Viene de inicio/login/registro SIN sesi√≥n - NO establecer flag');
                // NO establecer flag - dejar que auth.js maneje la redirecci√≥n
            } else {
                // En cualquier otro caso, establecer flag por seguridad
                sessionStorage.setItem('index_acceso_permitido', 'true');
                console.log('‚úÖ [index.html HEAD] Flag establecido por seguridad');
            }
        })();
    </script>
    <style>
        /* Estilos responsivos espec√≠ficos para index.html */
        @media (max-width: 768px) {
            .filter-container {
                padding: 1rem !important;
            }

            .filter-container > div {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 1rem !important;
            }

            .filter-container label {
                width: 100% !important;
                text-align: left !important;
            }

            .filter-select {
                width: 100% !important;
                min-width: auto !important;
                max-width: 100% !important;
            }
        }
    </style>

</head>

<body>

    <!-- Header -->

    <header class="header">

        <h1>Registro de Animales</h1>

        <nav class="nav-bar">

            <a href="index.html" class="nav-item active">

                <span class="nav-icon">üìö</span>

                Biblioteca

            </a>

            <a href="mapa-consolidado.html" class="nav-item">

                <span class="nav-icon">üó∫</span>

                Mapa Consolidado

            </a>

            <a href="bloc-notas.html" class="nav-item">

                <span class="nav-icon">üìù</span>

                Bloc de Notas

            </a>

            <a href="admin.html" class="nav-item admin-nav-item" id="adminNavItem" style="display: none;">

                <span class="nav-icon">‚öô</span>

                Administraci√≥n

            </a>

        </nav>

        <div class="user-info">

            <span id="userName" class="user-name"></span>

            <button id="logoutBtn" class="btn-logout" title="Cerrar sesi√≥n">üö™</button>

        </div>

    </header>



    <!-- Search and Action Bar -->

    <div class="search-bar-container">

        <div class="search-wrapper">

            <span class="search-icon">üîç</span>

            <input type="text" id="searchInput" class="search-input" placeholder="Buscar registros...">

        </div>

        <div class="action-buttons">

            <button class="btn-filter" id="sortBtn">

                <span>üîÑ</span>

                Recientes primero

            </button>

            <button class="btn-primary" id="newRecordBtn">

                <span>+</span>

                Nuevo Registro

            </button>

        </div>

    </div>

    

    <!-- Filtros de Categor√≠a y Subcategor√≠a -->

    <div class="filter-container" style="padding: 1rem 2rem; background: white; border-bottom: 1px solid #e0e0e0;">

        <div style="display: flex; gap: 1rem; align-items: center; max-width: 1200px; margin: 0 auto;">

            <label style="font-weight: 600; color: #4D8143;">Filtrar por:</label>

            <select id="filterCategoria" class="filter-select" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem; min-width: 250px;">

                <option value="">Todas las categorias</option>

            </select>

            <select id="filterSubcategoria" class="filter-select" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem; min-width: 250px;" disabled>

                <option value="">Todas las subcategorias</option>

            </select>

        </div>

    </div>



    <!-- Main Content -->

    <main class="main-content">

        <div class="records-grid" id="recordsGrid">

            <!-- Los registros se cargar√°n din√°micamente aqu√≠ -->

        </div>

    </main>



    <!-- Modal para confirmar eliminaci√≥n -->

    <div id="deleteModal" class="modal">

        <div class="modal-content">

            <h3>¬øEliminar registro?</h3>

            <p>Esta acci√≥n no se puede deshacer.</p>

            <div class="modal-actions">

                <button class="btn-cancel" id="cancelDeleteBtn">Cancelar</button>

                <button class="btn-delete" id="confirmDeleteBtn">Eliminar</button>

            </div>

        </div>

    </div>



    <script src="../assets/js/auth.js"></script>

    <script src="../assets/js/script.js"></script>

    <script>

        // ELIMINADA la verificaci√≥n de autenticaci√≥n aqu√≠
        // auth.js manejar√° la verificaci√≥n correctamente
        // Solo limpiar el flag de vieneDeLogin si existe
        document.addEventListener('DOMContentLoaded', () => {
            const vieneDeLogin = sessionStorage.getItem('vieneDeLogin') === 'true';
            if (vieneDeLogin) {
                sessionStorage.removeItem('vieneDeLogin');
                console.log('‚úÖ Flag vieneDeLogin limpiado');
            }
            
            // INTERCEPTAR CLICS EN ENLACES DE NAVEGACI√ìN para establecer flag antes de navegar
            const navLinks = document.querySelectorAll('.nav-bar a[href]');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    // Si NO es index.html (Biblioteca), establecer flag de navegaci√≥n interna
                    if (href && href !== 'index.html' && !href.includes('inicio.html') && !href.includes('login.html') && !href.includes('registro.html')) {
                        console.log('üîó [index.html] Navegando a:', href);
                        console.log('‚úÖ [index.html] Estableciendo flag de navegaci√≥n interna');
                        // Establecer flag que indica que el usuario est√° navegando internamente
                        sessionStorage.setItem('navegando_internamente', 'true');
                        sessionStorage.setItem('pagina_destino', href);
                        // Cuando regrese a index.html, este flag permitir√° el acceso
                        sessionStorage.setItem('index_acceso_permitido', 'true');
                    }
                });
            });
            
            console.log('‚úÖ Interceptores de navegaci√≥n configurados');
        });

        // Mostrar informaci√≥n del usuario

        document.addEventListener('DOMContentLoaded', async () => {

            const user = window.authSystem.getCurrentUser();

            if (user) {

                document.getElementById('userName').textContent = `üë§ ${user.nombre}`;

                

                // Verificar rol desde la API si no est√° en la sesi√≥n

                let userRol = user.rol;

                if (!userRol) {

                    try {

                        const response = await fetch(`../api/api.php?action=get_user_info&user_id=${user.id}`);

                        const data = await response.json();

                        if (data.success && data.user && data.user.rol) {

                            userRol = data.user.rol;

                            // Actualizar la sesi√≥n con el rol

                            const updatedUser = { ...user, rol: userRol };

                            window.authSystem.setSession(updatedUser);

                        }

                    } catch (error) {

                        console.error('Error al obtener rol del usuario:', error);

                    }

                }

                

                // Mostrar bot√≥n de administraci√≥n si es admin

                if (userRol === 'admin') {

                    const adminNavItem = document.getElementById('adminNavItem');

                    if (adminNavItem) {

                        adminNavItem.style.display = 'flex';

                        console.log('Bot√≥n de administraci√≥n mostrado');

                    }

                } else {

                    console.log('Usuario no es admin. Rol:', userRol);

                }

            }

            

            // Bot√≥n cerrar sesi√≥n

            document.getElementById('logoutBtn').addEventListener('click', () => {

                if (confirm('¬øDeseas cerrar sesi√≥n?')) {

                    window.authSystem.logout();

                    window.location.href = 'inicio.html';

                }

            });

        });

    </script>
    
    <!-- PWA Service Worker Registration -->
    <script src="../assets/js/pwa-register.js"></script>

</body>

</html>
