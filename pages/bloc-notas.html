<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <title>Bloc de Notas - Organic Journal</title>
    <link rel="icon" type="image/jpeg" href="../assets/logo.jpg">
    <link rel="shortcut icon" type="image/jpeg" href="../assets/logo.jpg">
    <link rel="stylesheet" href="../assets/css/styles.css">

    <style>

        .notes-container {

            max-width: 1000px;

            margin: 2rem auto;

            padding: 0 2rem;

        }

        .notes-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            margin-bottom: 2rem;

        }

        .notes-header h2 {

            color: #4D8143;

        }

        .notes-list {

            display: flex;

            flex-direction: column;

            gap: 1rem;

        }

        .note-item {

            background: white;

            padding: 1.5rem;

            border-radius: 8px;

            box-shadow: 0 2px 5px rgba(0,0,0,0.1);

        }

        .note-header {

            display: flex;

            justify-content: space-between;

            align-items: start;

            margin-bottom: 1rem;

        }

        .note-title {

            font-weight: 600;

            font-size: 1.1rem;

            color: #333;

        }

        .note-date {

            color: #666;

            font-size: 0.9rem;

        }

        .note-content {

            color: #555;

            line-height: 1.6;

        }

    </style>

</head>

<body>

    <header class="header teal-header">

        <h1>Registro de Animales</h1>

        <nav class="nav-bar">

            <a href="index.html" class="nav-item">

                <span class="nav-icon">üìö</span>

                Biblioteca

            </a>

            <a href="mapa-consolidado.html" class="nav-item">

                <span class="nav-icon">üó∫</span>

                Mapa Consolidado

            </a>

            <a href="bloc-notas.html" class="nav-item active">

                <span class="nav-icon">üìù</span>

                Bloc de Notas

            </a>

            <a href="grupos.html" class="nav-item" id="gruposNavItem" style="display: none;">

                <span class="nav-icon">üë•</span>

                Grupos

            </a>

            <a href="admin.html" class="nav-item admin-nav-item" id="adminNavItem" style="display: none;">

                <span class="nav-icon">‚öô</span>

                Administraci√≥n

            </a>

        </nav>

        <div class="user-info" id="userInfoWrap">
            <div class="profile-dropdown-wrapper">
                <button type="button" class="profile-trigger" id="profileTrigger" aria-expanded="false" aria-haspopup="true" aria-label="Abrir men√∫ de usuario">
                    <span class="profile-avatar" id="profileAvatar" style="width:22px;height:22px;min-width:22px;min-height:22px;max-width:22px;max-height:22px;overflow:hidden;flex-shrink:0;display:inline-flex;align-items:center;justify-content:center;border-radius:50%"><img src="../assets/icons/perfil-removebg-preview.png" alt="" style="width:100%;height:100%;max-width:22px;max-height:22px;object-fit:cover;display:block"></span>
                    <span class="user-name" id="userName"></span>
                    <span class="profile-chevron" aria-hidden="true">‚ñº</span>
                </button>
                <div class="profile-dropdown" id="profileDropdown" role="menu" hidden style="position: absolute !important; top: 100% !important; right: 0 !important; left: auto !important; width: 320px !important;">
                <div class="profile-dropdown-header">
                    <div class="profile-dropdown-name" id="profileDropdownName"></div>
                    <div class="profile-dropdown-email" id="profileDropdownEmail"></div>
                </div>
                <div class="profile-dropdown-links" style="display: flex !important; flex-direction: column !important; gap: 0.5rem !important; padding: 0.75rem !important;">
                    <a href="catalogo.html" class="profile-dropdown-link" role="menuitem" style="display: block !important; width: 100% !important; margin-bottom: 0.5rem !important;"><span class="profile-dropdown-icon">üå≥</span> Cat√°logo de categor√≠as</a>
                    <a href="recuperar-contrase√±a.html" class="profile-dropdown-link" role="menuitem" style="display: block !important; width: 100% !important; margin-bottom: 0.5rem !important;"><span class="profile-dropdown-icon">üîê</span> Cambiar contrase√±a</a>
                    <a href="inicio.html" class="profile-dropdown-link" role="menuitem" style="display: block !important; width: 100% !important; margin-bottom: 0.5rem !important;"><span class="profile-dropdown-icon">üè†</span> Ir al inicio</a>
                    <a href="admin.html" class="profile-dropdown-link" id="profileDropdownAdmin" style="display: none; width: 100% !important; margin-bottom: 0.5rem !important;" role="menuitem"><span class="profile-dropdown-icon">‚öô</span> Administraci√≥n</a>
                </div>
                <div class="profile-dropdown-divider"></div>
                <button type="button" class="profile-dropdown-item logout" id="profileLogoutBtn" role="menuitem"><span class="profile-dropdown-icon">üö™</span> Cerrar sesi√≥n</button>
                </div>
            </div>
        </div>
    </header>
    <script>
    (function(){ var p = (window.location.pathname || ''); var base = p.indexOf('/pages/') !== -1 ? '../' : ''; var el = document.getElementById('profileAvatar'); if (el) { var img = el.querySelector('img'); if (img) img.src = base + 'assets/icons/perfil-removebg-preview.png'; } })();
    (function(){ var path = window.location.pathname || ''; if (path.indexOf('/pages/') === -1) { var segs = path.split('/').filter(Boolean); if (segs.length <= 1) { document.querySelectorAll('.nav-bar .nav-item').forEach(function(a){ var h = a.getAttribute('href'); if (h && !/^https?:/.test(h) && h.charAt(0) !== '/') a.setAttribute('href', 'pages/' + h); }); } } })();
    </script>
    <!-- Modal: ¬øAcceder a chats o nueva solicitud? -->
    <div id="chatChoiceModal" class="email-modal" style="display: none; position: fixed; inset: 0; z-index: 9999; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);">
        <div class="email-modal-content chat-choice-content" style="background: rgba(255,255,255,0.7); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-radius: 16px; padding: 2rem 2.25rem; max-width: 420px; width: 90%; box-shadow: 0 25px 50px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.8);">
            <h2>üí¨ Chat de Ejidos</h2>
            <p style="margin: 1rem 0;">¬øQu√© deseas hacer?</p>
            <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.25rem;">
                <button type="button" id="btnAccederChats" class="btn-primary" style="width: 100%; padding: 0.9rem;">Acceder a mis chats</button>
                <button type="button" id="btnNuevaSolicitud" class="btn-secondary" style="width: 100%; padding: 0.9rem;">Enviar nueva solicitud</button>
                <button type="button" id="btnCancelarChatChoice" class="btn-secondary" style="width: 100%; padding: 0.6rem; background: #e0e0e0;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Notes Container -->

    <div class="notes-container">

        <div class="notes-header">

            <h2>Resumen de Registros</h2>
            
            <div style="display: flex; gap: 1rem; align-items: center;">
                <select id="sortSelect" style="padding: 0.5rem 1rem; border: 2px solid #4D8143; border-radius: 8px; font-size: 1rem; background: white; color: #333; cursor: pointer;">
                    <option value="recientes">M√°s recientes primero</option>
                    <option value="antiguos">M√°s antiguos primero</option>
                    <option value="nombre_asc">Nombre A-Z</option>
                    <option value="nombre_desc">Nombre Z-A</option>
                    <option value="categoria">Por categor√≠a</option>
                </select>
            </div>

        </div>

        <div class="notes-list" id="notesList">

            <!-- Las notas se cargar√°n din√°micamente -->

        </div>

    </div>

    <script src="../assets/js/auth.js"></script>

    <script>
        // INTERCEPTAR CLIC EN ENLACE DE BIBLIOTECA para establecer flag antes de navegar
        // Ejecutar INMEDIATAMENTE sin esperar DOMContentLoaded
        (function() {
            // Establecer flag inmediatamente cuando se carga la p√°gina (por si el usuario ya est√° navegando)
            sessionStorage.setItem('index_acceso_permitido', 'true');

            // Tambi√©n interceptar clics cuando el DOM est√© listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    const bibliotecaLink = document.querySelector('a[href="index.html"], a[href="pages/index.html"]');
                    if (bibliotecaLink) {
                        bibliotecaLink.addEventListener('click', function(e) {

                            sessionStorage.setItem('navegando_internamente', 'true');
                            sessionStorage.setItem('index_acceso_permitido', 'true');

                        });
                    }
                });
            } else {
                // DOM ya est√° listo
                const bibliotecaLink = document.querySelector('a[href="index.html"], a[href="pages/index.html"]');
                if (bibliotecaLink) {
                    bibliotecaLink.addEventListener('click', function(e) {

                        sessionStorage.setItem('navegando_internamente', 'true');
                        sessionStorage.setItem('index_acceso_permitido', 'true');

                    });
                }
            }
        })();
    </script>

    <script>

        document.addEventListener('DOMContentLoaded', async () => {

            // Mostrar informaci√≥n del usuario (authSystem o sesi√≥n en storage)
            let user = window.authSystem ? window.authSystem.getCurrentUser() : null;
            if (!user) {
                try {
                    const sessionJson = sessionStorage.getItem('current_session') || localStorage.getItem('current_session');
                    if (sessionJson) user = JSON.parse(sessionJson);
                } catch (e) { }
            }

            if (user) {

                const nombre = user.nombre || 'Usuario';
                const inicial = nombre.charAt(0).toUpperCase();
                document.getElementById('userName').textContent = nombre;
                var av = document.getElementById('profileAvatar'); if (av && !av.querySelector('img')) av.textContent = inicial;
                document.getElementById('profileDropdownName').textContent = nombre;
                document.getElementById('profileDropdownEmail').textContent = user.email || '';

                let userRol = user.rol;

                if (!userRol) {

                    try {

                        const currentUrl = window.location.href.toLowerCase();
                        const isHostinger = currentUrl.indexOf('hostinger') !== -1 || 
                                           currentUrl.indexOf('hostingersite.com') !== -1 ||
                                           currentUrl.indexOf('organicjournal.com.mx') !== -1;
                        const apiUrl = isHostinger 
                            ? `/api/api.php?action=get_user_info&user_id=${user.id}`
                            : `../api/api.php?action=get_user_info&user_id=${user.id}`;
                        const response = await fetch(apiUrl);

                        const data = await response.json();

                        if (data.success && data.user && data.user.rol) {

                            userRol = data.user.rol;

                            const updatedUser = { ...user, rol: userRol };

                            window.authSystem.setSession(updatedUser);

                        }

                    } catch (error) {

                    }

                }

                if (userRol === 'admin') {

                    const adminNavItem = document.getElementById('adminNavItem');

                    if (adminNavItem) {

                        adminNavItem.style.display = 'flex';

                    }

                    const profileAdmin = document.getElementById('profileDropdownAdmin');

                    if (profileAdmin) {

                        profileAdmin.style.display = 'flex';

                    }

                }

                // Mostrar enlace de Grupos si est√° autenticado
                const gruposNavItem = document.getElementById('gruposNavItem');
                if (gruposNavItem) {
                    gruposNavItem.style.display = 'flex';
                    gruposNavItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const modal = document.getElementById('chatChoiceModal');
                        if (modal) { modal.style.display = 'flex'; modal.classList.add('show'); }
                    });
                }
                (function() {
                    const modal = document.getElementById('chatChoiceModal');
                    const btnChats = document.getElementById('btnAccederChats');
                    const btnSolicitud = document.getElementById('btnNuevaSolicitud');
                    const btnCancelar = document.getElementById('btnCancelarChatChoice');
                    if (!modal) return;
                    function closeModal() { modal.style.display = 'none'; modal.classList.remove('show'); }
                    async function goToChat() {
                        const baseUrl = window.location.origin;
                        const path = window.location.pathname;
                        const basePath = path.substring(0, path.lastIndexOf('/') + 1);
                        let estado = sessionStorage.getItem('chat_estado') || '';
                        let municipio = sessionStorage.getItem('chat_municipio') || '';
                        let ciudad = sessionStorage.getItem('chat_ciudad') || '';
                        if (!estado) {
                            try {
                                const sessionJson = sessionStorage.getItem('current_session') || localStorage.getItem('current_session');
                                const session = sessionJson ? JSON.parse(sessionJson) : null;
                                const userId = session && session.id != null ? parseInt(session.id, 10) : 0;
                                if (userId > 0 && userId < 2000000000) {
                                    const res = await fetch(baseUrl + basePath + '../api/chat_api.php?action=obtener_grupos&usuario_id=' + userId);
                                    const data = await res.json();
                                    if (data.success && data.grupos && data.grupos.length > 0) {
                                        const preferir = data.grupos.find(function(g) { return (g.nombre || '').trim() !== 'Ejidos M√©xico'; });
                                        const grupo = preferir || data.grupos[0];
                                        const nombre = (grupo.nombre || '').trim();
                                        if ((grupo.nombre || '').trim() !== 'Ejidos M√©xico') {
                                            if ((grupo.estado || '').trim()) estado = (grupo.estado || '').trim();
                                            else if (nombre.indexOf('Ejidos ') === 0) estado = nombre.substring(7);
                                        }
                                    }
                                }
                            } catch (e) { }
                        }
                        closeModal();
                        let chatUrl = baseUrl + basePath + 'chat.html';
                        if (estado) {
                            chatUrl += '?estado=' + encodeURIComponent(estado);
                            if (municipio) chatUrl += '&municipio=' + encodeURIComponent(municipio);
                            if (ciudad) chatUrl += '&ciudad=' + encodeURIComponent(ciudad);
                        }
                        window.location.href = chatUrl;
                    }
                    function goToGrupos() {
                        const baseUrl = window.location.origin;
                        const path = window.location.pathname;
                        const basePath = path.substring(0, path.lastIndexOf('/') + 1);
                        closeModal();
                        window.location.href = baseUrl + basePath + 'grupos.html';
                    }
                    if (btnChats) btnChats.addEventListener('click', goToChat);
                    if (btnSolicitud) btnSolicitud.addEventListener('click', goToGrupos);
                    if (btnCancelar) btnCancelar.addEventListener('click', closeModal);
                    modal.addEventListener('click', function(ev) { if (ev.target === modal) closeModal(); });
                })();

            }

            const profileTrigger = document.getElementById('profileTrigger');
            const profileDropdown = document.getElementById('profileDropdown');
            const profileLogoutBtn = document.getElementById('profileLogoutBtn');

            if (profileTrigger && profileDropdown) {
                profileTrigger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = profileDropdown.classList.toggle('is-open');
                    profileTrigger.classList.toggle('is-open', isOpen);
                    profileTrigger.setAttribute('aria-expanded', isOpen);
                    profileDropdown.hidden = !isOpen;
                });
                document.addEventListener('click', function() {
                    profileDropdown.classList.remove('is-open');
                    profileTrigger.classList.remove('is-open');
                    profileTrigger.setAttribute('aria-expanded', 'false');
                    profileDropdown.hidden = true;
                });
            }

            if (profileLogoutBtn) {
                profileLogoutBtn.addEventListener('click', () => {
                    if (confirm('¬øDeseas cerrar sesi√≥n?')) {
                        window.authSystem.logout();
                        window.location.href = 'inicio.html';
                    }
                });
            }

            loadNotes();
            
            // Configurar ordenamiento
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) {
                sortSelect.addEventListener('change', function() {
                    sortAndDisplayRecords();
                });
            }

        });
        
        let allRecords = []; // Variable global para almacenar todos los registros

        async function loadNotes() {
            const notesList = document.getElementById('notesList');
            const currentUser = window.authSystem ? window.authSystem.getCurrentUser() : null;
            
            if (!currentUser) {
                notesList.innerHTML = `
                    <div class="empty-state">
                        <h3>Debes iniciar sesi√≥n</h3>
                        <p>Por favor inicia sesi√≥n para ver tus registros</p>
                        <button onclick="window.location.href='inicio.html'" style="margin-top: 1rem; padding: 0.8rem 2rem; background: #4D8143; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: 600;">
                            Ir a la Aplicaci√≥n
                        </button>
                    </div>
                `;
                return;
            }
            
            // Mostrar estado de carga
            notesList.innerHTML = `
                <div class="empty-state">
                    <h3>Cargando registros...</h3>
                    <p>Por favor espera</p>
                </div>
            `;
            
            try {
                // Detectar entorno para la ruta de API
                const currentUrl = window.location.href.toLowerCase();
                const isHostinger = currentUrl.indexOf('hostinger') !== -1 || 
                                   currentUrl.indexOf('hostingersite.com') !== -1 ||
                                   currentUrl.indexOf('organicjournal.com.mx') !== -1;
                
                const currentPath = window.location.pathname;
                const isInPages = currentPath.indexOf('/pages/') !== -1;
                
                let apiUrl;
                // Cargar TODOS los registros sin filtrar por usuario
                if (isHostinger) {
                    // Usar ruta absoluta desde la ra√≠z
                    apiUrl = `/api/api.php?action=get_registros_ambientales`;
                } else {
                    if (isInPages) {
                        apiUrl = `../api/api.php?action=get_registros_ambientales`;
                    } else {
                        apiUrl = `api/api.php?action=get_registros_ambientales`;
                    }
                }
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    allRecords = data.records || [];
                    
                    if (allRecords.length === 0) {
                        notesList.innerHTML = `
                            <div class="empty-state">
                                <h3>No hay registros a√∫n</h3>
                                <p>Los registros aparecer√°n aqu√≠ cuando crees tu primer registro</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Ordenar y mostrar registros
                    sortAndDisplayRecords();
                } else {
                    notesList.innerHTML = `
                        <div class="empty-state">
                            <h3>Error al cargar registros</h3>
                            <p>${data.message || 'Intenta recargar la p√°gina'}</p>
                        </div>
                    `;
                }
            } catch (error) {

                notesList.innerHTML = `
                    <div class="empty-state">
                        <h3>Error de conexi√≥n</h3>
                        <p>No se pudieron cargar los registros. Verifica tu conexi√≥n e intenta recargar la p√°gina.</p>
                    </div>
                `;
            }
        }

        function sortAndDisplayRecords() {
            const notesList = document.getElementById('notesList');
            const sortSelect = document.getElementById('sortSelect');
            const sortBy = sortSelect ? sortSelect.value : 'recientes';
            
            let sortedRecords = [...allRecords];
            
            // Aplicar ordenamiento seg√∫n la opci√≥n seleccionada
            switch(sortBy) {
                case 'recientes':
                    sortedRecords.sort((a, b) => {
                        const dateA = new Date(a.fecha + (a.hora ? ' ' + a.hora : ''));
                        const dateB = new Date(b.fecha + (b.hora ? ' ' + b.hora : ''));
                        return dateB - dateA; // M√°s recientes primero
                    });
                    break;
                    
                case 'antiguos':
                    sortedRecords.sort((a, b) => {
                        const dateA = new Date(a.fecha + (a.hora ? ' ' + a.hora : ''));
                        const dateB = new Date(b.fecha + (b.hora ? ' ' + b.hora : ''));
                        return dateA - dateB; // M√°s antiguos primero
                    });
                    break;
                    
                case 'nombre_asc':
                    sortedRecords.sort((a, b) => {
                        const nombreA = (a.nombre || a.descripcion_breve || '').toLowerCase();
                        const nombreB = (b.nombre || b.descripcion_breve || '').toLowerCase();
                        return nombreA.localeCompare(nombreB);
                    });
                    break;
                    
                case 'nombre_desc':
                    sortedRecords.sort((a, b) => {
                        const nombreA = (a.nombre || a.descripcion_breve || '').toLowerCase();
                        const nombreB = (b.nombre || b.descripcion_breve || '').toLowerCase();
                        return nombreB.localeCompare(nombreA);
                    });
                    break;
                    
                case 'categoria':
                    sortedRecords.sort((a, b) => {
                        const catA = (a.categoria_nombre || '').toLowerCase();
                        const catB = (b.categoria_nombre || '').toLowerCase();
                        if (catA !== catB) {
                            return catA.localeCompare(catB);
                        }
                        // Si tienen la misma categor√≠a, ordenar por fecha reciente
                        const dateA = new Date(a.fecha + (a.hora ? ' ' + a.hora : ''));
                        const dateB = new Date(b.fecha + (b.hora ? ' ' + b.hora : ''));
                        return dateB - dateA;
                    });
                    break;
            }
            
            // Renderizar registros ordenados
            notesList.innerHTML = sortedRecords.map(record => {
                const fecha = record.fecha || record.fecha_creacion;
                const date = new Date(fecha);
                const categoriaNombre = record.categoria_nombre || 'Sin categor√≠a';
                const subcategoriaNombre = record.subcategoria_nombre || '';
                const nombre = record.nombre || record.descripcion_breve || 'Sin nombre';
                const especie = record.especie || '';
                const ubicacion = record.comunidad && record.sitio 
                    ? `${escapeHtml(record.comunidad)} - ${escapeHtml(record.sitio)}`
                    : record.latitud && record.longitud 
                        ? `${record.latitud}, ${record.longitud}`
                        : 'Sin ubicaci√≥n';
                const notas = record.observaciones || record.notas || record.descripcion_breve || 'Sin observaciones';
                const responsable = record.responsable || '';
                const brigada = record.brigada || '';
                const participantes = record.numero_participantes || '';
                const usuarioNombre = record.usuario_nombre || 'Usuario desconocido';
                
                return `
                    <div class="note-item">
                        <div class="note-header">
                            <div>
                                <div class="note-title">${escapeHtml(nombre)}${especie ? ' - ' + escapeHtml(especie) : ''}</div>
                                <div class="note-date">${date.toLocaleDateString('es-MX', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric'
                                })}${record.hora ? ' ‚Ä¢ ' + record.hora.substring(0, 5) : ''}</div>
                                ${categoriaNombre ? `<div style="margin-top: 0.5rem;"><span style="background: #4D8143; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.85rem;">${escapeHtml(categoriaNombre)}</span>${subcategoriaNombre ? ' <span style="background: #6B9B5A; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.85rem;">' + escapeHtml(subcategoriaNombre) + '</span>' : ''}</div>` : ''}
                            </div>
                        </div>
                        <div class="note-content">
                            <strong>üë§ Registrado por:</strong> ${escapeHtml(usuarioNombre)}<br>
                            ${ubicacion !== 'Sin ubicaci√≥n' ? `<strong>üìç Ubicaci√≥n:</strong> ${ubicacion}<br>` : ''}
                            ${responsable ? `<strong>üë§ Responsable:</strong> ${escapeHtml(responsable)}${brigada ? ' - ' + escapeHtml(brigada) : ''}<br>` : ''}
                            ${participantes ? `<strong>üë• Participantes:</strong> ${participantes}<br>` : ''}
                            ${record.tipo_actividad ? `<strong>üîß Tipo de Actividad:</strong> ${escapeHtml(record.tipo_actividad)}<br>` : ''}
                            <strong>üìù Observaciones:</strong> ${escapeHtml(notas)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

    </script>
    
    <!-- Bloquear navegaci√≥n con flechas del navegador -->
    <script src="../assets/js/block-navigation.js"></script>

</body>

</html>
