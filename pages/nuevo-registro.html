<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Nuevo Registro - Organic Journal</title>
    <link rel="icon" type="image/jpeg" href="../assets/logo.jpg">
    <link rel="shortcut icon" type="image/jpeg" href="../assets/logo.jpg">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4D8143">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ProNatura">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../assets/icons/icon-152x152.png">
    
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        .field-label-wrap { display: inline-flex; align-items: center; gap: 0.35rem; }
        .field-info-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 1.1rem; height: 1.1rem; border-radius: 50%;
            background: #4D8143; color: #fff; font-size: 0.7rem; font-weight: bold;
            cursor: pointer; user-select: none; flex-shrink: 0;
        }
        .field-info-icon:hover { background: #3d6b35; }
        .field-info-popover {
            display: none; position: fixed; z-index: 10000;
            max-width: 280px; padding: 0.75rem 1rem; border-radius: 8px;
            background: #1a1a1a; color: #fff; font-size: 0.9rem; line-height: 1.4;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        .field-info-popover.visible { display: block; }
        .field-info-popover-text { margin-bottom: 0.5rem; }
        .field-info-audio-btn {
            display: inline-flex; align-items: center; justify-content: center;
            width: 32px; height: 32px; border-radius: 50%;
            background: #4D8143; color: #fff; border: none;
            font-size: 1rem; cursor: pointer; margin-top: 4px;
        }
        .field-info-audio-btn:hover { background: #3d6b35; }
        .field-info-audio-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous"
    />
    <!-- VERIFICACI√ìN INMEDIATA EN HEAD - ANTES DE CUALQUIER SCRIPT -->
    <script>
        // Verificar INMEDIATAMENTE si viene del panel de administraci√≥n
        // Esto se ejecuta ANTES de que se carguen los scripts de autenticaci√≥n
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isEditMode = urlParams.get('edit') === 'true';
            const editingFromAdmin = sessionStorage.getItem('editingFromAdmin') === 'true';
            
            if (isEditMode || editingFromAdmin) {

                // Marcar en window para que el script de verificaci√≥n lo detecte
                window._editingFromAdmin = true;
                window._skipAuthCheck = true; // Marcar para saltar verificaci√≥n de auth.js
            }
        })();
    </script>
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
    ></script>
</head>
<body>
    <!-- Limpiar modo edici√≥n si la URL no tiene edit=true (as√≠ "+ Nuevo Registro" no abre el registro anterior) -->
    <script>
    (function() {
        var q = window.location.search || '';
        if (q.indexOf('edit=true') === -1) {
            try { sessionStorage.removeItem('editingRecord'); sessionStorage.removeItem('editingFromAdmin'); } catch (e) {}
        }
    })();
    </script>
    <!-- Cargar categor√≠as y subcategor√≠as aunque form-script.js falle o est√© en cach√© -->
    <script>
    (function() {
        function apiUrl(action) {
            var h = window.location.href.toLowerCase();
            if (h.indexOf('organicjournal.com.mx') !== -1 || h.indexOf('hostinger') !== -1) return '/api/api.php?action=' + action;
            var p = window.location.pathname || '';
            return (p.indexOf('/pages/') !== -1 ? '../api/api.php' : 'api/api.php') + '?action=' + action;
        }
        function cargarCats() {
            var sel = document.getElementById('categoria');
            if (!sel) return;
            fetch(apiUrl('get_categorias')).then(function(r) { return r.json(); }).then(function(d) {
                if (d.success && d.categorias && d.categorias.length) {
                    sel.innerHTML = '<option value="">Selecciona una categor√≠a</option>';
                    d.categorias.forEach(function(c) {
                        var o = document.createElement('option');
                        o.value = c.id;
                        o.textContent = c.nombre;
                        sel.appendChild(o);
                    });
                }
            }).catch(function() {});
        }
        function cargarSubs(catId) {
            var sel = document.getElementById('subcategoria');
            if (!sel || !catId) return;
            fetch(apiUrl('get_subcategorias') + '&categoria_id=' + catId).then(function(r) { return r.json(); }).then(function(d) {
                sel.innerHTML = '<option value="">Selecciona una subcategor√≠a (opcional)</option>';
                if (d.success && d.subcategorias) d.subcategorias.forEach(function(s) {
                    var o = document.createElement('option');
                    o.value = s.id;
                    o.textContent = s.nombre;
                    sel.appendChild(o);
                });
            }).catch(function() {});
        }
        document.addEventListener('DOMContentLoaded', function() {
            cargarCats();
            var cat = document.getElementById('categoria');
            if (cat) cat.addEventListener('change', function() {
                var id = this.value;
                if (id) cargarSubs(id); else { var s = document.getElementById('subcategoria'); if (s) s.innerHTML = '<option value="">Selecciona primero una categor√≠a</option>'; }
            });
            // Bot√≥n cerrar (‚úï) y Cancelar: redirigir aunque form-script.js falle
            function irAtras() {
                if (window.confirm('¬øDeseas cancelar? Los cambios no guardados se perder√°n.')) {
                    var fromAdmin = sessionStorage.getItem('editingFromAdmin') === 'true';
                    sessionStorage.removeItem('editingRecord');
                    sessionStorage.removeItem('editingFromAdmin');
                    window.location.href = fromAdmin ? 'admin.html#registros' : 'index.html';
                }
            }
            var closeBtn = document.getElementById('closeBtn');
            if (closeBtn) closeBtn.addEventListener('click', irAtras);
            var cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) cancelBtn.addEventListener('click', irAtras);
            // Respaldo: botones de ubicaci√≥n y evidencia (por si form-script.js tarda o falla)
            var selectLocationBtn = document.getElementById('selectLocationBtn');
            if (selectLocationBtn && typeof openLocationModal === 'function') {
                selectLocationBtn.addEventListener('click', function() { openLocationModal(); });
            }
            var uploadBtn = document.getElementById('uploadBtn');
            var mediaInput = document.getElementById('mediaInput');
            if (uploadBtn && mediaInput) {
                uploadBtn.addEventListener('click', function() { mediaInput.click(); });
            }
        });
    })();
    </script>
    <!-- Form Container -->
    <div class="form-container">
        <div class="form-header">
            <h2 id="formTitle">Nuevo Registro</h2>
            <button class="close-btn" id="closeBtn">‚úï</button>
        </div>

        <form id="newRecordForm" class="record-form">
            <!-- Categor√≠a y Subcategor√≠a -->
            <div class="form-group">
                <label for="categoria"><span class="field-label-wrap">Categor√≠a * <span class="field-info-icon" data-field="categoria" title="Ayuda">i</span></span></label>
                <select id="categoria" name="categoria" required>
                    <option value="">Selecciona una categor√≠a</option>
                </select>
            </div>

            <div class="form-group">
                <label for="subcategoria"><span class="field-label-wrap">Subcategor√≠a <span class="field-info-icon" data-field="subcategoria" title="Ayuda">i</span></span></label>
                <select id="subcategoria" name="subcategoria">
                    <option value="">Selecciona primero una categor√≠a</option>
                </select>
            </div>

            <!-- Fecha y Hora -->
            <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                <div>
                    <label for="fecha"><span class="field-label-wrap">Fecha * <span class="field-info-icon" data-field="fecha" title="Ayuda">i</span></span></label>
                    <input type="date" id="fecha" name="fecha" required>
                </div>
                <div>
                    <label for="hora"><span class="field-label-wrap">Hora <span class="field-info-icon" data-field="hora" title="Ayuda">i</span></span></label>
                    <input type="time" id="hora" name="hora">
                </div>
            </div>

            <!-- Responsable y Brigada -->
            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label for="responsable"><span class="field-label-wrap">Responsable <span class="field-info-icon" data-field="responsable" title="Ayuda">i</span></span></label>
                    <input type="text" id="responsable" name="responsable" placeholder="Nombre del responsable">
                </div>
                <div>
                    <label for="brigada"><span class="field-label-wrap">Brigada <span class="field-info-icon" data-field="brigada" title="Ayuda">i</span></span></label>
                    <input type="text" id="brigada" name="brigada" placeholder="Nombre de la brigada">
                </div>
            </div>

            <!-- Comunidad y Sitio -->
            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label for="comunidad"><span class="field-label-wrap">Comunidad <span class="field-info-icon" data-field="comunidad" title="Ayuda">i</span></span></label>
                    <input type="text" id="comunidad" name="comunidad" placeholder="Nombre de la comunidad">
                </div>
                <div>
                    <label for="sitio"><span class="field-label-wrap">Sitio <span class="field-info-icon" data-field="sitio" title="Ayuda">i</span></span></label>
                    <input type="text" id="sitio" name="sitio" placeholder="Nombre del sitio">
                </div>
            </div>

            <!-- Tipo de Actividad -->
            <div class="form-group">
                <label for="tipo_actividad"><span class="field-label-wrap">Tipo de Actividad <span class="field-info-icon" data-field="tipo_actividad" title="Ayuda">i</span></span></label>
                <input type="text" id="tipo_actividad" name="tipo_actividad" placeholder="Ej: Patrullaje rutinario, Limpieza comunitaria">
            </div>

            <!-- Descripci√≥n Breve -->
            <div class="form-group">
                <label for="descripcion_breve"><span class="field-label-wrap">Descripci√≥n Breve <span class="field-info-icon" data-field="descripcion_breve" title="Ayuda">i</span></span></label>
                <textarea id="descripcion_breve" name="descripcion_breve" rows="2" placeholder="Descripci√≥n corta de la actividad"></textarea>
            </div>

            <!-- Campos originales (opcionales para compatibilidad) -->
            <details style="margin: 1rem 0; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                <summary style="cursor: pointer; font-weight: 600;">Campos Adicionales (Opcional)</summary>
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="nombre">Nombre (para registros de fauna)</label>
                    <input type="text" id="nombre" name="nombre" placeholder="Nombre del animal o especie">
                </div>
                <div class="form-group">
                    <label for="especie">Especie</label>
                    <input type="text" id="especie" name="especie" placeholder="Especie identificada">
                </div>
            </details>

            <!-- Ubicaci√≥n -->
            <div class="form-group">
                <label>Ubicaci√≥n (GPS) *</label>
                <div class="location-inputs">
                    <div class="location-field">
                        <label for="latitud">Latitud *</label>
                        <input type="number" id="latitud" name="latitud" step="any" placeholder="Ej: 19.4326" required>
                    </div>
                    <div class="location-field">
                        <label for="longitud">Longitud *</label>
                        <input type="number" id="longitud" name="longitud" step="any" placeholder="Ej: -99.1332" required>
                    </div>
                </div>
                <button type="button" class="btn-map" id="selectLocationBtn">
                    <span>üìç</span>
                    Seleccionar ubicaci√≥n en el mapa
                </button>
            </div>

            <!-- Evidencia (Fotos, Videos, Audio) -->
            <div class="form-group">
                <label>Evidencia (Fotos, Videos, Audio)</label>
                <button type="button" class="btn-upload" id="uploadBtn">
                    <span>üì§</span>
                    A√±adir evidencia
                </button>
                <input type="file" id="mediaInput" name="media" accept="image/*,video/*,audio/*" multiple style="display: none;">
                <div id="mediaPreview" class="media-preview"></div>
            </div>

            <!-- Observaciones -->
            <div class="form-group">
                <label for="observaciones">Observaciones</label>
                <textarea id="observaciones" name="observaciones" rows="4" placeholder="Observaciones adicionales sobre la actividad..."></textarea>
            </div>

            <!-- Materiales Utilizados y N√∫mero de Participantes -->
            <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                <div>
                    <label for="materiales_utilizados">Materiales Utilizados</label>
                    <textarea id="materiales_utilizados" name="materiales_utilizados" rows="2" placeholder="Lista de materiales utilizados"></textarea>
                </div>
                <div>
                    <label for="numero_participantes">N√∫mero de Participantes</label>
                    <input type="number" id="numero_participantes" name="numero_participantes" min="0" placeholder="0">
                </div>
            </div>

            <!-- Notas (legacy, para compatibilidad) -->
            <div class="form-group">
                <label for="notas">Notas Adicionales</label>
                <textarea id="notas" name="notas" rows="3" placeholder="Notas adicionales (opcional)"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="cancelBtn">Cancelar</button>
                <button type="submit" class="btn-save">Guardar</button>
            </div>
        </form>
    </div>

    <!-- Popover de ayuda por campo -->
    <div id="fieldInfoPopover" class="field-info-popover" role="tooltip"></div>

    <!-- Modal de Selecci√≥n de Ubicaci√≥n -->
    <div id="locationModal" class="modal">
        <div class="modal-content location-modal">
            <div class="modal-header">
                <h3>Selecciona una ubicaci√≥n</h3>
                <button class="close-btn" id="closeLocationModal">‚úï</button>
            </div>
            <p class="modal-instructions">
                Haz clic en el mapa para seleccionar una ubicaci√≥n o ingresa las coordenadas manualmente:
            </p>
            <div class="map-container" style="position: relative;">
                <div id="locationMap" style="width: 100%; height: 400px; border-radius: 8px; z-index: 1;"></div>
                <div class="map-coordinates-display" id="mapCoordinates" style="position: absolute; bottom: 10px; left: 10px; background: rgba(255,255,255,0.95); padding: 0.5rem 0.75rem; border-radius: 4px; font-size: 0.85rem; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-weight: 600; color: #2c7a7b;">23.7, -99.0</div>
            </div>
            <div class="coordinate-inputs">
                <div class="coordinate-field">
                    <label for="modalLatitud">Latitud</label>
                    <input type="number" id="modalLatitud" step="any" value="23.7">
                </div>
                <div class="coordinate-field">
                    <label for="modalLongitud">Longitud</label>
                    <input type="number" id="modalLongitud" step="any" value="-99.0">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-confirm" id="confirmLocationBtn">Confirmar ubicaci√≥n</button>
            </div>
        </div>
    </div>

    <!-- VERIFICACI√ìN INMEDIATA ANTES DE CUALQUIER SCRIPT -->
    <script>
        // Verificar INMEDIATAMENTE si viene del panel de administraci√≥n
        // Esto se ejecuta ANTES de que se carguen los scripts de autenticaci√≥n
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isEditMode = urlParams.get('edit') === 'true';
            const editingFromAdmin = sessionStorage.getItem('editingFromAdmin') === 'true';

            if (isEditMode || editingFromAdmin) {

                // Marcar en window para que el script de verificaci√≥n lo detecte
                window._editingFromAdmin = true;
                window._skipAuthCheck = true;
                window._skipUserCheck = true;
                
                // SOBRESCRIBIR confirm para prevenir que se ejecute el modal de cuenta
                window._originalConfirm = window.confirm;
                window.confirm = function(message) {
                    if (message && (message.includes('cuenta registrada') || message.includes('Ya tienes una cuenta'))) {

                        return false; // Retornar false para cancelar y evitar redirecci√≥n
                    }
                    // Para otros confirms, usar el original
                    return window._originalConfirm.call(window, message);
                };

            }
        })();
    </script>
    
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/admin-auth.js"></script>
    <script>
        // ESTABLECER FLAG ANTES DE CUALQUIER COSA
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const editingRecord = sessionStorage.getItem('editingRecord');
            if (urlParams.get('edit') === 'true' || editingRecord) {

                window._isPopulatingForm = true;
            }
        })();
        
        // Verificar autenticaci√≥n despu√©s de que los scripts se carguen
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar si viene del panel de administraci√≥n
            const urlParams = new URLSearchParams(window.location.search);
            const isEditMode = urlParams.get('edit') === 'true';
            const editingFromAdmin = sessionStorage.getItem('editingFromAdmin') === 'true' || window._editingFromAdmin === true;

            // PRIORIDAD M√ÅXIMA: Si viene del panel de administraci√≥n, permitir acceso inmediatamente
            if (isEditMode || editingFromAdmin) {

                return; // Salir inmediatamente sin verificar nada m√°s
            }
            
            // Esperar un momento para que adminAuthSystem se cargue completamente
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // IMPORTANTE: Verificar primero si es administrador (para casos normales tambi√©n)
            let isAdmin = false;
            if (window.adminAuthSystem && typeof window.adminAuthSystem.isAuthenticated === 'function') {
                isAdmin = window.adminAuthSystem.isAuthenticated();

            }
            
            if (isAdmin) {

                return; // Permitir acceso si es administrador
            }
            
            // VERIFICAR NUEVAMENTE si viene del panel admin (por si acaso)
            const urlParamsCheck = new URLSearchParams(window.location.search);
            const isEditModeCheck = urlParamsCheck.get('edit') === 'true';
            const editingFromAdminCheck = sessionStorage.getItem('editingFromAdmin') === 'true' || window._editingFromAdmin === true;
            
            if (isEditModeCheck || editingFromAdminCheck) {

                return; // Salir inmediatamente sin mostrar modal
            }
            
            // Si no es administrador, verificar usuario normal
            const currentUser = window.authSystem ? window.authSystem.getCurrentUser() : null;
            
            if (!currentUser) {
                // Mostrar modal preguntando si tiene cuenta
                const hasAccount = confirm('¬øYa tienes una cuenta registrada?\n\n- Clic en "Aceptar" si ya tienes cuenta (ir√°s a iniciar sesi√≥n)\n- Clic en "Cancelar" si no tienes cuenta (ir√°s a registrarte)');
                
                if (hasAccount) {
                    // Tiene cuenta, ir a inicio.html para iniciar sesi√≥n
                    window.location.href = 'inicio.html';
                } else {
                    // No tiene cuenta, ir a registro
                    window.location.href = 'registro.html';
                }
            }
        });
    </script>
    <script src="../assets/js/form-script.js?v=5"></script>
    <script>
        (function() {
            // Ruta del audio de ayuda: pega aqu√≠ la ruta a tu archivo .mp3 (ej: '../assets/audio/ayuda.mp3')
            var AUDIO_AYUDA_URL = '';

            var descripciones = {
                categoria: 'Tipo principal de la actividad o monitoreo (ej. Flora, Fauna, Reforestaci√≥n). Elige la que mejor describa tu registro.',
                subcategoria: 'Detalle espec√≠fico dentro de la categor√≠a elegida. Se habilita despu√©s de seleccionar una categor√≠a (opcional).',
                fecha: 'D√≠a en que se realiz√≥ la actividad. Es un campo obligatorio.',
                hora: 'Hora aproximada en que ocurri√≥ la actividad (opcional).',
                responsable: 'Nombre de la persona a cargo de la actividad o del registro.',
                brigada: 'Nombre del equipo o brigada que realiz√≥ la actividad (ej. Brigada Norte, Equipo de monitoreo).',
                comunidad: 'Localidad o comunidad donde se realiz√≥ la actividad (ej. nombre del ejido o poblaci√≥n).',
                sitio: 'Lugar espec√≠fico o punto del √°rea: paraje, predio, nombre del sitio o referencia.',
                tipo_actividad: 'Qu√© se hizo: por ejemplo patrullaje rutinario, limpieza comunitaria, monitoreo de fauna, reforestaci√≥n.',
                descripcion_breve: 'Resumen corto de la actividad realizada. Sirve para identificar r√°pido el registro.'
            };
            document.addEventListener('DOMContentLoaded', function() {
                var popover = document.getElementById('fieldInfoPopover');
                if (!popover) return;
                function cerrarPopover() {
                    popover.classList.remove('visible');
                    document.removeEventListener('click', cerrarPopover);
                }
                function escucharAyuda(e) {
                    e.stopPropagation();
                    if (!AUDIO_AYUDA_URL) return;
                    var audio = new Audio(AUDIO_AYUDA_URL);
                    audio.play().catch(function() {});
                }
                document.querySelectorAll('.field-info-icon').forEach(function(icon) {
                    icon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        var field = this.getAttribute('data-field');
                        var text = descripciones[field] || '';
                        if (!text) return;
                        if (popover.classList.contains('visible')) {
                            cerrarPopover();
                            return;
                        }
                        popover.innerHTML =
                            '<div class="field-info-popover-text">' + text + '</div>' +
                            '<button type="button" class="field-info-audio-btn" title="Escuchar">&#128266;</button>';
                        var btn = popover.querySelector('.field-info-audio-btn');
                        if (btn) {
                            btn.addEventListener('click', escucharAyuda);
                            if (!AUDIO_AYUDA_URL) btn.disabled = true;
                        }
                        popover.classList.add('visible');
                        var rect = this.getBoundingClientRect();
                        popover.style.left = rect.left + 'px';
                        popover.style.top = (rect.bottom + 6) + 'px';
                        setTimeout(function() { document.addEventListener('click', cerrarPopover); }, 0);
                    });
                });
            });
        })();
    </script>
    <!-- PWA Service Worker Registration -->
    <script src="../assets/js/pwa-register.js?v=2"></script>
    
    <!-- Bloquear navegaci√≥n con flechas del navegador -->
    <script src="../assets/js/block-navigation.js"></script>
</body>
</html>

